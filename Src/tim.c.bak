//	----------------------------------------------------------------------------------------------------
//	COMPANY	NAME	:
//	PROJECT	NAME	:
//	FILE	NAME	:	tim.c
//	MAKE	BY		:
//	DESCRIPTION		:
//	CREATED DATE	:	2019.03.04
//	----------------------------------------------------------------------------------------------------


// Includes
#include "stm32f7xx.h"
#include "main.h"
#include "lwip.h"


// Defines



// Variables
uint32_t g_deTimer6Cnt = 0;


// Structures
EffDataTrRate_t Edtr;


// Functions
void TIM_INIT(void);
void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim);

void TIM_INIT(void)
{
	  HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_1);
	  HAL_TIM_Base_Start_IT(&htim6);
}

void HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef *htim)
{
	static uint16_t l_deRateCnt = 0;
	static uint16_t l_de1sCnt = 0, l_de500msCnt = 0, l_de10msCnt = 0, l_de1msCnt = 0;

	if(htim->Instance == TIM6)	// periodic interrupt function(main timer)
	{
		(Dout.Led1Inv == 1)?(GPIOD->BSRR = 0x00000001):(GPIOD->BSRR = 0x00010000);// Signal of Routine
		Dout.Led2Inv = 1;
		GPIOD->BSRR = 0x00000002;// Start Signal of Interrupt Routine(Set to High)


		RTC_COUNT();

		g_deTimer6Cnt++;
		if(g_deTimer6Cnt == 36000000)	// Count Up Per 100 usec For 1 Hour
		{
			g_deTimer6Cnt = 0;
		}

		l_deRateCnt++;
		if(l_deRateCnt == 10000)
		{
			l_deRateCnt = 0;
		}

		l_de1sCnt++;
		if(l_de1sCnt == 10000)
		{
			g_de1sFlg = 1;
			l_de1sCnt = 0;
		}
		l_de500msCnt++;
		if(l_de500msCnt == 5000)
		{
			g_de500msFlg = 1;
			l_de500msCnt = 0;
		}

		l_de10msCnt++;
		if(l_de10msCnt == 100)
		{
			g_de10msFlg = 1;
			l_de10msCnt = 0;
		}
		l_de1msCnt++;
		if(l_de1msCnt == 10)
		{
			g_de1msFlg = 1;
			l_de1msCnt = 0;
		}
		g_de100usFlg = 1;

		GPIO_READ();			// Read Gpio
		GPIO_WRITE();			// Write Gpio

		MX_LWIP_Process();		// Renewal Ethernet

		Dout.Led2Inv = 0;
		GPIOD->BSRR = 0x00020000;// End Signal of Interrupt Routine(Reset to Low)
	}
	HAL_TIM_Base_Start_IT(&htim6);
}
